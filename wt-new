#!/usr/bin/env bash
set -euo pipefail

readonly REPO_PARENTS=("code" "hc" "scripts")

title="${1:-}"

if [[ -z "$title" ]]; then
  echo "Usage: wt-new <Title>" >&2
  exit 1
fi

repo_root=$(git rev-parse --show-toplevel)
repo_name=$(basename "$repo_root")
repo_parent=$(dirname "$repo_root")
parent_name=$(basename "$repo_parent")

valid_parent=false
for parent in "${REPO_PARENTS[@]}"; do
  if [[ "$parent_name" == "$parent" ]]; then
    valid_parent=true
    break
  fi
done

if [[ "$valid_parent" == false ]]; then
  echo "Error: Repository must be in one of: ${REPO_PARENTS[*]}" >&2
  exit 1
fi

username=$(whoami | tr '[:upper:] ' '[:lower:]-')
branch_name="$username/$title"
worktree_path="$repo_parent/$repo_name.$title"

if [[ -e "$worktree_path" ]]; then
  echo "Error: Path already exists: $worktree_path" >&2
  exit 1
fi

echo "Creating worktree:"
echo "  Branch: $branch_name"
echo "  Path: $worktree_path"

git worktree add -b "$branch_name" "$worktree_path"

echo "Done. Switch to: cd $worktree_path"
